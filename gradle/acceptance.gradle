/**
 * Acceptance tasks
 *
 * Only used to run from a packaged Ontrack application against a running server.
 *
 * For local development testing, running the following tasks is enough:
 *
 * ./gradlew build localAcceptanceTest
 */


import net.nemerosa.ontrack.gradle.*

/**
 * Running local acceptance tests end to end
 */

dockerCompose {
    ci {
        useComposeFiles = ["compose/docker-compose-ci.yml"]
        projectName = "ci"
        captureContainersOutputToFiles = "${project.buildDir}/ci-logs"
        waitForTcpPorts = false
    }
}

task ciAcceptanceTest(type: RemoteAcceptanceTest) {
    dependsOn "ciComposeUp"
    doFirst {
        def ontrackPort = dockerCompose.ci.servicesInfos.ontrack.'ontrack_1'.ports.get(8080) as int
        acceptanceUrl = { "http://localhost:${ontrackPort}" }
    }
    disableSsl = true
    acceptanceTimeout = 300
    acceptanceImplicitWait = 30
    finalizedBy ciComposeDown
}
