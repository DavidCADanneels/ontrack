/**
 * Acceptance tests for the OS packages
 */
import net.nemerosa.ontrack.gradle.DockerBuild
import net.nemerosa.ontrack.gradle.DockerExec
import net.nemerosa.ontrack.gradle.DockerStart
import net.nemerosa.ontrack.gradle.DockerStop
import net.nemerosa.ontrack.gradle.RemoteAcceptanceTest

/**
 * Debian tests
 */

task debDockerPrepare(type: Copy) {
    copy {
        from project.properties.acceptanceDebianDistributionDir
        include '*.deb'
        into 'gradle/os-package/docker/debian/'
        rename '.*', 'ontrack.deb'
    }
}

task debDockerBuild(type: DockerBuild, dependsOn: debDockerPrepare) {
    dir = file('gradle/os-package/docker/debian')
    tag = 'nemerosa/ontrack-debian'
}

task debDockerRun(type: DockerStart, dependsOn: debDockerBuild) {
    image = 'nemerosa/ontrack-debian'
    tty = true
    command = '/bin/cat'
    ports = [8080: 0]
}

task debDockerStart(type: DockerExec, dependsOn: debDockerRun) {
    startTask = 'debDockerRun'
    commands = [
            start: ['service', 'ontrack', 'start'],
    ]
}

task debDockerStop(type: DockerStop) {
    startTask = 'debDockerRun'
}

task debAcceptanceTest(type: RemoteAcceptanceTest) {
    acceptanceUrl = { "http://${project.properties.acceptanceHost}:${debDockerRun.getActualPort(8080)}" }
    acceptanceContext = 'smoke' // Only basic test
    disableSsl = true
    dependsOn debDockerStart
    finalizedBy debDockerStop
}

/**
 * TODO RPM tests
 */

task rpmAcceptanceTest

/**
 * OS packages tests
 */

task osPackageAcceptanceTest {
    dependsOn debAcceptanceTest
    dependsOn rpmAcceptanceTest
}