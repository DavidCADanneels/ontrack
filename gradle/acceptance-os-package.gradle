/**
 * Acceptance tests for the OS packages
 */

import net.nemerosa.ontrack.gradle.DockerBuild
import net.nemerosa.ontrack.gradle.DockerCopy
import net.nemerosa.ontrack.gradle.DockerExec
import net.nemerosa.ontrack.gradle.DockerStart
import net.nemerosa.ontrack.gradle.DockerStop

/**
 * Debian tests
 */

task debDockerBuild(type: DockerBuild) {
    dir = file('gradle/os-package/docker/debian')
    tag = 'nemerosa/ontrack-debian'
}

task debDockerStart(type: DockerStart, dependsOn: debDockerBuild) {
    image = 'nemerosa/ontrack-debian'
    tty = true
    command = '/bin/cat'
}

String getDebianSourcePath() {
    if (project.hasProperty('ontrack.debian')) {
        return project.properties['ontrack.debian']
    } else {
        return 'build/distributions'
    }
}

task debDockerCopy(type: DockerCopy, dependsOn: debDockerStart) {
    doFirst {
        def src = getDebianSourcePath()
        println "[${name}] Copying Debian package from ${src}"
        project.mkdir 'build/os-package/debian/'
        project.copy {
            from src
            include '*.deb'
            into 'build/os-package/debian/'
            rename '.*', 'ontrack.deb'
        }
    }
    startTask = 'debDockerStart'
    sourcePath = 'build/os-package/debian/ontrack.deb'
    containerPath = '/root/ontrack.deb'
}

task debDockerInstall(type: DockerExec, dependsOn: debDockerCopy) {
    startTask = 'debDockerStart'
    commands = [
            dpkg: ['dpkg', '-i', '/root/ontrack.deb'],
    ]
}

task debDockerStop(type: DockerStop) {
    startTask = 'debDockerStart'
}

task debAcceptanceTest(/*type: RemoteAcceptanceTest*/) {
//    acceptanceUrl = { "https://${project.properties.acceptanceHost}:${debDockerStart.port}" }
//    disableSsl = true
    dependsOn debDockerInstall
    finalizedBy debDockerStop
}

/**
 * TODO RPM tests
 */

task rpmAcceptanceTest

/**
 * OS packages tests
 */

task osPackageAcceptanceTest {
    dependsOn debAcceptanceTest
    dependsOn rpmAcceptanceTest
}