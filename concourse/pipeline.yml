# fly -t local set-pipeline -p ontrack -c concourse/pipeline.yml -l concourse/parameters.yml -l concourse/secrets.yml

resources:
  - name: repo-code
    type: git
    source:
        uri: ((github-repo))
        branch: ((branch))
        ignore_paths: ["concourse/images/*"]
  - name: repo-images
    type: git
    source:
        uri: ((github-repo))
        branch: ((branch))
        paths: ["concourse/images/*"]
  - name: image-ontrack-ci
    type: docker-image
    source:
      repository: ((docker-hub-organization))/ontrack-ci-image
      username: ((docker-hub-username))
      password: ((docker-hub-password))
      tag: ((docker-hub-tag))

jobs:
  - name: build-images
    plan:
    - get: repo-images
      trigger: true
    - put: image-ontrack-ci
      params:
        build: repo-images/concourse/images/ci
  - name: package
    plan:
      - get: image-ontrack-ci
        trigger: true
        passed: [build-images]
      - get: repo-code
        trigger: true
      - task: build
        image: image-ontrack-ci
        file: repo-code/concourse/tasks/build.yml
